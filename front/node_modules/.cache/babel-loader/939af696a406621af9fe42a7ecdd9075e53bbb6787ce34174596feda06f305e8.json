{"ast":null,"code":"var _jsxFileName = \"/Users/takiacademy/Desktop/blog/front/src/contexts/JWTAuthContext.tsx\",\n  _s = $RefreshSig$();\nimport jwtDecode from \"jwt-decode\";\nimport axios from \"../utils/axios\";\nimport { createContext, useEffect, useReducer } from \"react\";\nimport Loading from \"../components/Loading\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst initialAuthState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null\n};\nconst isValidToken = token => {\n  if (!token) {\n    return false;\n  }\n  const decoded = jwtDecode(token);\n  const currentTime = Date.now() / 1000;\n  return decoded.exp > currentTime;\n};\nconst setSession = token => {\n  if (token) {\n    localStorage.setItem(\"token\", token);\n    axios.defaults.headers.common.Authorization = `Bearer ${token}`;\n  } else {\n    localStorage.removeItem(\"token\");\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case \"INITIALISE\":\n      {\n        const {\n          isAuthenticated,\n          user\n        } = action.payload;\n        console.log(isAuthenticated);\n        return {\n          ...state,\n          isAuthenticated,\n          isInitialised: true,\n          user\n        };\n      }\n    case \"LOGIN\":\n      {\n        const {\n          user\n        } = action.payload;\n        console.log(user);\n        return {\n          ...state,\n          isAuthenticated: true\n        };\n      }\n    case \"LOGOUT\":\n      {\n        return {\n          ...state,\n          isAuthenticated: false,\n          user: null\n        };\n      }\n    default:\n      {\n        return {\n          ...state\n        };\n      }\n  }\n};\nconst AuthContext = /*#__PURE__*/createContext({\n  ...initialAuthState,\n  method: \"JWT\",\n  login: (email, password) => Promise.resolve(),\n  logout: () => {}\n});\nexport const AuthProvider = _ref => {\n  _s();\n  let {\n    children\n  } = _ref;\n  const [state, dispatch] = useReducer(reducer, initialAuthState);\n  const login = async (email, password) => {\n    const response = await axios.post(\"http://v1/user/login\", {\n      email,\n      password\n    });\n    console.log(response);\n    const user = response.data.data.user;\n    console.log(user);\n    const token = response.data.data.token;\n    setSession(token);\n    dispatch({\n      type: \"LOGIN\",\n      payload: {\n        user\n      }\n    });\n  };\n  const logout = () => {\n    setSession(null);\n    // TODO: useReducer with typescript !!!\n    dispatch({\n      type: \"LOGOUT\",\n      payload: {}\n    });\n  };\n  useEffect(() => {\n    const initialise = async () => {\n      try {\n        const token = window.localStorage.getItem(\"token\");\n        if (token && isValidToken(token)) {\n          setSession(token);\n          const response = await axios.get(\"/profile/my\");\n          const user = response.data.data;\n          dispatch({\n            type: \"INITIALISE\",\n            payload: {\n              isAuthenticated: true,\n              user\n            }\n          });\n        } else {\n          dispatch({\n            type: \"INITIALISE\",\n            payload: {\n              isAuthenticated: false,\n              user: null\n            }\n          });\n        }\n      } catch (err) {\n        console.error(err);\n        dispatch({\n          type: \"INITIALISE\",\n          payload: {\n            isAuthenticated: false,\n            user: null\n          }\n        });\n      }\n    };\n    initialise();\n  }, []);\n  if (!state.isInitialised) {\n    return /*#__PURE__*/_jsxDEV(Loading, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 141,\n      columnNumber: 12\n    }, this);\n  }\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: {\n      ...state,\n      method: \"JWT\",\n      logout,\n      login\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 145,\n    columnNumber: 5\n  }, this);\n};\n_s(AuthProvider, \"//4mWrSOuqoEUUutHOK3gWkly1o=\");\n_c = AuthProvider;\nexport default AuthContext;\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["jwtDecode","axios","createContext","useEffect","useReducer","Loading","jsxDEV","_jsxDEV","initialAuthState","isAuthenticated","isInitialised","user","isValidToken","token","decoded","currentTime","Date","now","exp","setSession","localStorage","setItem","defaults","headers","common","Authorization","removeItem","reducer","state","action","type","payload","console","log","AuthContext","method","login","email","password","Promise","resolve","logout","AuthProvider","_ref","_s","children","dispatch","response","post","data","initialise","window","getItem","get","err","error","fileName","_jsxFileName","lineNumber","columnNumber","Provider","value","_c","$RefreshReg$"],"sources":["/Users/takiacademy/Desktop/blog/front/src/contexts/JWTAuthContext.tsx"],"sourcesContent":["import { DecodedToken, JWTState, User } from \"../types/contexts\";\nimport jwtDecode from \"jwt-decode\";\nimport axios from \"../utils/axios\";\nimport { PayloadAction } from \"@reduxjs/toolkit\";\nimport { createContext, ReactNode, useEffect, useReducer } from \"react\";\nimport Loading from \"../components/Loading\";\n\nconst initialAuthState: JWTState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null,\n};\n\nconst isValidToken = (token: string): boolean => {\n  if (!token) {\n    return false;\n  }\n  const decoded: DecodedToken = jwtDecode(token);\n  const currentTime = Date.now() / 1000;\n  return decoded.exp > currentTime;\n};\n\nconst setSession = (token: string | null) => {\n  if (token) {\n    localStorage.setItem(\"token\", token);\n    axios.defaults.headers.common.Authorization = `Bearer ${token}`;\n  } else {\n    localStorage.removeItem(\"token\");\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\n\nconst reducer = (state: JWTState, action: PayloadAction<JWTState>) => {\n  switch (action.type) {\n    case \"INITIALISE\": {\n      const { isAuthenticated, user } = action.payload;\n      console.log(isAuthenticated);\n      return {\n        ...state,\n        isAuthenticated,\n        isInitialised: true,\n        user,\n      };\n    }\n    case \"LOGIN\": {\n      const { user } = action.payload;\n      console.log(user);\n      return {\n        ...state,\n        isAuthenticated: true,\n      };\n    }\n    case \"LOGOUT\": {\n      return {\n        ...state,\n        isAuthenticated: false,\n        user: null,\n      };\n    }\n    default: {\n      return { ...state };\n    }\n  }\n};\n\nconst AuthContext = createContext({\n  ...initialAuthState,\n  method: \"JWT\",\n  login: (email: string, password: string) => Promise.resolve(),\n  logout: () => {},\n});\n\nexport const AuthProvider = ({ children }: { children: ReactNode }) => {\n  const [state, dispatch] = useReducer(reducer, initialAuthState);\n\n  const login = async (email: string, password: string) => {\n    const response = await axios.post(\"http://v1/user/login\", {\n      email,\n      password,\n    });\n    console.log(response);\n    const user = response.data.data.user;\n    console.log(user);\n    const token = response.data.data.token;\n    setSession(token);\n    dispatch({\n      type: \"LOGIN\",\n      payload: {\n        user,\n      },\n    });\n  };\n\n  const logout = () => {\n    setSession(null);\n    // TODO: useReducer with typescript !!!\n    dispatch({ type: \"LOGOUT\", payload: {} });\n  };\n\n  useEffect(() => {\n    const initialise = async () => {\n      try {\n        const token = window.localStorage.getItem(\"token\");\n        if (token && isValidToken(token)) {\n          setSession(token);\n          const response = await axios.get(\"/profile/my\");\n          const user = response.data.data;\n\n          dispatch({\n            type: \"INITIALISE\",\n            payload: {\n              isAuthenticated: true,\n              user,\n            },\n          });\n        } else {\n          dispatch({\n            type: \"INITIALISE\",\n            payload: {\n              isAuthenticated: false,\n              user: null,\n            },\n          });\n        }\n      } catch (err) {\n        console.error(err);\n        dispatch({\n          type: \"INITIALISE\",\n          payload: {\n            isAuthenticated: false,\n            user: null,\n          },\n        });\n      }\n    };\n\n    initialise();\n  }, []);\n\n  if (!state.isInitialised) {\n    return <Loading />;\n  }\n\n  return (\n    <AuthContext.Provider\n      value={{\n        ...state,\n        method: \"JWT\",\n        logout,\n        login,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport default AuthContext;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}